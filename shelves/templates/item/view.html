{% set params=item %}
{% set entity='item' %}

{% extends 'base.html' %}

{% block menu %}
  <a class="dropdown-item btnAddToKit" href="#">Add to already owned kit</a>
{% endblock %}

{% block content %}
  {{ super() }}
  <div class="container">
    <div class="row">
      <div class="page-header">
        <h3 class="pt-4 pb-2">
        Item of <a href="{{ url_for('catalog.view', id=item['catalog_id']) }}">{{ item['type_title'] }} : {{ item['title_eng'] or item['title'] }}</a>
        {% if g.user['id'] == item['owner_id'] or g.user.admin %}<a href="{{ url_for('item.update', id=item['id']) }}"><i class="fas fa-edit"></i></a>{% endif %}
        </h3>
      </div>
    </div>
  </div>
  <div class="container">
    <div class="row">
      <div class="col-2">
        <p>Internal ID {{ item['internal_id'] }}</p>
      </div>
      <div class="col-3">
        <p>In collection since {{ item['added'].strftime('%Y-%m-%d') }}</p>
      </div>
    </div>
    <div class="row"><div class="col-12">
      <p>{{ item['description'] | markdown }}</p>
    </div></div>
    <div class="row">
      <div class="col-12">
        <h4 class="pt-4">Real item photos</h4>
        {% if g.user['id'] == item['owner_id'] %}
          {{ upload_files_control('photo_upload', 'Upload') }}
        {% endif %}
      </div>
    </div>

    <div id="imagesList">
    </div>

<!--     <div class="row">
      <div class="col-12">
        <a class="btn btn-primary btnAddToKit" href="#">Add to already owned kit</a>
      </div>
    </div>
 -->
    <div id="itemKits"></div>
      <script type="text/babel">
        ReactDOM.render(
          <ItemListSection includes="{{ item['id'] }}" title="Included by the item"/>,
          document.getElementById('itemKits')
        );
      </script>

    <div id="itemChildren"></div>
      <script type="text/babel">
        ReactDOM.render(
          <ItemListSection parent="{{ item['id'] }}" title="Includes the items"/>,
          document.getElementById('itemChildren')
        );
      </script>
  </div>

<div class="modal fade" id="modalAddToKit" tabindex="-1" role="dialog" aria-labelledby="modalAddToKitTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalAddToKitTitle">Add {{ item['type_title'] }} : {{ item['title'] }} to the kit</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <select class="form-control" id="modalAddToKitList">
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary btnAddToKitCommit">Add</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
  {{ super() }}

<script type="text/javascript">

$(document).on('click', '.btnAddToKit', function (e) {
    e.preventDefault();
    $('#modalAddToKit').modal('show');
});

/* Load kits into modal window */
$('#modalAddToKit').on('show.bs.modal', function (event) {
    $.getJSON(flask_util.url_for('item._items_filtered'),
        { collection:{{ item['collection_id'] }}, includes_catalog:{{ item['catalog_id'] }} },
        function(response) {
            var $list = $('#modalAddToKitList');
            $list.empty();
            $.each(response.result, function(k, v) {
                $opt = $('<option>').val(v.id).append(v.title);
                $list.append($opt);
            });
        }
    );
});

$(document).on('click', '.btnAddToKitCommit', function (e) {
    e.preventDefault();
    $('#modalAddToKit').modal('hide');
    var $list = $('#modalAddToKitList');
    $.getJSON(flask_util.url_for('item._add_to_kit', {id:{{ item['id'] }} }),
        { kit:$list.val() },
        function() {
            itemKits.loadData();
        });
});

</script>

{% endblock %}
